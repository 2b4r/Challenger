<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ø§Ù„Ù…ØµØ­Ù | Ù†Øµ + Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª + Ø§Ù„Ù…Ø®ØªØµØ±</title>
<meta name="description" content="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø«Ù…Ø§Ù†ÙŠØŒ Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙƒÙ„Ù…Ø© Ø¨ÙƒÙ„Ù…Ø©ØŒ ØªÙØ³ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±ØŒ Ù†Ø³Ø® Ø§Ù„Ø¢ÙŠØ§ØªØŒ ÙˆØ­ÙØ¸ Ø¢Ø®Ø± Ù…ÙˆØ¶Ø¹." />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#0b1220;--card:#0e1626;--mut:#9fb3c8;--bor:#1e2b46;--acc:#06b6d4;--txt:#eaf2ff;
  --fsize:22px; /* Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø¢ÙŠØ§Øª */
}
:root.light{--bg:#f7fafc;--card:#ffffff;--mut:#4a5568;--bor:#e2e8f0;--acc:#0ea5e9;--txt:#0f172a}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.7 system-ui,Segoe UI,Arial}
header{position:sticky;top:0;z-index:5;background:color-mix(in sRGB,var(--bg) 92%,transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--bor)}
.wrap{max-width:1100px;margin:0 auto;padding:10px 12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.brand{font-weight:800;display:flex;gap:8px;align-items:center}
.pill{background:color-mix(in sRGB,var(--bg) 60%,#0000);border:1px solid var(--bor);border-radius:999px;padding:5px 10px;color:color-mix(in sRGB,var(--txt) 85%,#fff)}
select,input{background:color-mix(in sRGB,var(--bg) 70%,#0000);border:1px solid var(--bor);color:var(--txt);border-radius:10px;padding:8px 10px;outline:none}
main{padding:14px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:960px){.grid{grid-template-columns:1fr 380px}}
.card{background:var(--card);border:1px solid var(--bor);border-radius:16px;padding:12px}
.surahHead{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:1px solid var(--bor);background:color-mix(in sRGB,var(--acc) 18%, var(--bg));color:var(--txt);border-radius:10px;padding:8px 10px;cursor:pointer}
.btn:hover{filter:brightness(1.05)} .ghost{background:transparent}
.ayah{padding:10px;border:1px solid var(--bor);border-radius:12px;margin-bottom:10px;background:color-mix(in sRGB,var(--bg) 85%,#0000)}
.ayah .meta{display:flex;gap:8px;align-items:center;color:var(--mut);font-size:12px;margin-bottom:6px;flex-wrap:wrap}
.words{line-height:2.2;word-spacing:.3ch;font-size:var(--fsize)}
.word{display:inline-block;padding:.12rem .28rem;border-radius:8px;cursor:pointer}
.word:hover{background:color-mix(in sRGB,var(--acc) 14%, var(--bg))}
.tooltip{position:fixed;z-index:10;background:color-mix(in sRGB,var(--bg) 98%,#0000);border:1px solid var(--bor);border-radius:10px;padding:8px 10px;max-width:70vw}
.badge{font-size:12px;color:color-mix(in sRGB,var(--txt) 70%,#fff)}
.loader{opacity:.75}
.switch{border:1px solid var(--bor);background:transparent;border-radius:999px;padding:6px 10px;cursor:pointer}
.small{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div class="brand">ğŸ“– Ø§Ù„Ù…ØµØ­Ù â€” Ù†Øµ + Ù…Ø¹Ø§Ù†ÙŠ + Ø§Ù„Ù…Ø®ØªØµØ±</div>
    <div class="row">
      <button id="theme" class="switch" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™/â˜€ï¸</button>
      <div class="row">
        <button id="fsDec" class="switch" title="ØªØµØºÙŠØ± Ø§Ù„Ø®Ø·">Aâˆ’</button>
        <button id="fsReset" class="switch" title="Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">A</button>
        <button id="fsInc" class="switch" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·">A+</button>
      </div>
      <button id="resume" class="switch" title="Ø§Ø°Ù‡Ø¨ Ù„Ø¢Ø®Ø± Ù…ÙˆØ¶Ø¹">â¤´ï¸ Ù…ØªØ§Ø¨Ø¹Ø©</button>
      <span class="pill" id="pwaState" style="display:none"></span>
    </div>
  </div>
  <div class="wrap row" style="gap:10px 12px">
    <select id="surahSel"></select>
    <input id="searchAyah" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©â€¦" style="flex:1 1 280px">
    <button id="prev" class="btn">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <button id="next" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div class="surahHead">
      <div><span id="sName" style="font-weight:800"></span> <span id="sInfo" class="badge"></span></div>
      <div class="row">
        <button id="copyAll" class="btn">Ù†Ø³Ø® Ø§Ù„Ø³ÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©</button>
      </div>
    </div>
    <div class="small">Ø§Ø¶ØºØ· ÙƒÙ„Ù…Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù†Ø§Ù‡Ø§ â€¢ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ù„ÙƒÙ„ Ø¢ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ©.</div>
    <div id="ayahs"></div>
  </section>

  <aside class="card">
    <h3>Ø§Ù„ØªÙØ³ÙŠØ± â€” Ø§Ù„Ù…Ø®ØªØµØ±</h3>
    <div id="tafsirBox" style="min-height:180px"><span class="badge">Ø§Ø®ØªØ± Ø¢ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ³ÙŠØ±â€¦</span></div>
    <h3 style="margin-top:14px">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h3>
    <div>
      <label class="pill"><input type="checkbox" id="optArabic"> ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø¥Ù† ØªÙˆÙØ±)</label>
      <div class="badge" style="margin-top:6px">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù†Ø§Ù‡Ø§</div>
    </div>
  </aside>
</main>

<div id="tooltip" class="tooltip" style="display:none"></div>

<script>
/* ====== PWA register ====== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js');
      const el = document.getElementById('pwaState'); el.style.display='inline-block';
      el.textContent = reg.active ? 'âœ… Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø¬Ø§Ù‡Ø²' : 'â€¦Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†';
    } catch(e){ /* ignore */ }
  });
}

/* ====== Theme + Font size ====== */
const THEME_KEY='q_theme', FS_KEY='q_fs';
(function initTheme(){
  const t = localStorage.getItem(THEME_KEY);
  if(t==='light') document.documentElement.classList.add('light');
  const fs = +localStorage.getItem(FS_KEY) || 22;
  document.documentElement.style.setProperty('--fsize', fs+'px');
})();
document.getElementById('theme').onclick = ()=>{
  document.documentElement.classList.toggle('light');
  localStorage.setItem(THEME_KEY, document.documentElement.classList.contains('light')?'light':'dark');
};
const setFS = v=>{ document.documentElement.style.setProperty('--fsize', v+'px'); localStorage.setItem(FS_KEY, v); };
document.getElementById('fsInc').onclick = ()=> setFS(Math.min(40, (+getComputedStyle(document.documentElement).getPropertyValue('--fsize').replace('px','')||22)+2));
document.getElementById('fsDec').onclick = ()=> setFS(Math.max(16, (+getComputedStyle(document.documentElement).getPropertyValue('--fsize').replace('px','')||22)-2));
document.getElementById('fsReset').onclick = ()=> setFS(22);

/* ====== API & Elements ====== */
const API = "https://api.quran.com/api/v4";
const sSel = document.getElementById('surahSel'), sName = document.getElementById('sName'), sInfo = document.getElementById('sInfo');
const ayahsEl = document.getElementById('ayahs'), tBox = document.getElementById('tafsirBox');
const searchEl = document.getElementById('searchAyah'); const tip = document.getElementById('tooltip');
const optAr = document.getElementById('optArabic');
let CHAPS=[], CUR=1, AYAH_TAFSIR={}, TAFSIR_ID=null, CUR_SURAH_NAME='';

/* ====== Utils ====== */
const qsa = (sel,root=document)=>[...root.querySelectorAll(sel)];
function copy(txt){ navigator.clipboard?.writeText(txt); }
function esc(s){ return s.replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m])); }
function decodeHtml(s){ return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>'); }

/* ====== Chapters ====== */
async function fetchChapters(){
  const r = await fetch(`${API}/chapters?language=ar`); const j = await r.json();
  CHAPS = j.chapters||[];
  sSel.innerHTML = CHAPS.map(c=>`<option value="${c.id}">${c.id}. ${c.name_simple} â€” ${c.name_arabic}</option>`).join('');
}

/* ====== Resolve â€œØ§Ù„Ù…Ø®ØªØµØ±â€ id (fallbacks) ====== */
async function resolveMukhtasarId(){
  try{
    const r = await fetch(`${API}/resources/tafsirs?language=ar`); const j = await r.json();
    const list = j.tafsirs||[];
    const pick = kw => list.find(t => (t.name||'').includes(kw) || (t.slug||'').includes(kw));
    return (pick('Ø§Ù„Ù…Ø®ØªØµØ±')||pick('mukhtasar')||pick('Ø§Ù„Ù…ÙŠØ³Ø±')||pick('muyassar')||pick('Ø§Ø¨Ù† ÙƒØ«ÙŠØ±')||pick('kathir'))?.id || null;
  }catch(e){ return null; }
}

/* ====== Load Surah ====== */
async function loadSurah(ch){
  CUR = ch; localStorage.setItem('last_ch', ch); localStorage.setItem('last_verse',''); // reset last verse selection
  sSel.value = ch;
  const chapter = CHAPS.find(c=>c.id==ch);
  CUR_SURAH_NAME = chapter?.name_arabic || '';
  sName.textContent = `${CUR_SURAH_NAME} (${chapter?.name_simple||''})`;
  sInfo.textContent = `${chapter?.revelation_place==='makkah'?'Ù…ÙƒÙŠ':'Ù…Ø¯Ù†ÙŠ'} â€¢ ${chapter?.verses_count} Ø¢ÙŠØ©`;
  ayahsEl.innerHTML = `<div class="badge loader">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øªâ€¦</div>`;

  const langPref = optAr.checked ? 'ar' : 'en';
  let page=1, pages=1, all=[];
  do{
    const url = `${API}/verses/by_chapter/${ch}?language=${langPref}&words=true&word_fields=translation,transliteration&fields=text_uthmani&per_page=50&page=${page}`;
    const r = await fetch(url); const j = await r.json();
    all = all.concat(j.verses||[]);
    pages = j.pagination?.total_pages || 1; page++;
  } while(page<=pages);

  renderAyat(all);
  await loadSurahTafsir(ch);
}

/* ====== Load Tafsir ====== */
async function loadSurahTafsir(ch){
  AYAH_TAFSIR = {};
  if(!TAFSIR_ID){ tBox.innerHTML=`<span class="badge">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ â€œØ§Ù„Ù…Ø®ØªØµØ±â€ Ø§Ù„Ø¢Ù†.</span>`; return; }
  tBox.innerHTML = `<span class="badge loader">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ³ÙŠØ±â€¦</span>`;
  try{
    const url = `${API}/tafsirs/${TAFSIR_ID}?chapter_number=${ch}`;
    const r = await fetch(url); const j = await r.json();
    (j.tafsirs||[]).forEach(t => { AYAH_TAFSIR[t.verse_key] = t.text; });
    tBox.innerHTML = `<span class="badge">Ø§Ø¶ØºØ· Ø¢ÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙØ³ÙŠØ±Ù‡Ø§</span>`;
  }catch(e){
    tBox.innerHTML = `<span class="badge">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ±.</span>`;
  }
}

/* ====== Render ====== */
function renderAyat(list){
  const q = (searchEl.value||'').trim();
  const filtered = q ? list.filter(v => (v.text_uthmani||'').includes(q) || (v.verse_key||'').includes(q)) : list;

  ayahsEl.innerHTML = filtered.map(v=>{
    const words = (v.words||[]).map(w=>{
      const tr = w.translation?.text || w.transliteration?.text || '';
      const disp = w.text_uthmani || w.code_v1 || w.text_indopak || w.text_imlaei_simple || w.char_type_name;
      return `<span class="word" data-mean="${esc(tr||'')}" data-key="${v.verse_key}">${disp}</span>`;
    }).join(' ');

    const copy1 = `ï´¿${(v.text_uthmani||'').trim()}ï´¾ (${v.verse_key})`;
    const [sId,aNum] = String(v.verse_key).split(':');
    const copy2 = `ï´¿${(v.text_uthmani||'').trim()}ï´¾ (${CUR_SURAH_NAME} ${aNum})`;

    return `
      <div class="ayah" id="a-${v.verse_key}">
        <div class="meta">
          <span class="pill">ï´¿ ${v.verse_number} ï´¾</span>
          <button class="btn ghost" data-copy="${esc(copy1)}" title="Ù†Ø³Ø®: Ù†Øµ + Ø±Ù‚Ù… Ø§Ù„Ù…ÙØªØ§Ø­">ğŸ“‹ Ù†Ø³Ø® (2:255)</button>
          <button class="btn ghost" data-copy="${esc(copy2)}" title="Ù†Ø³Ø®: Ù†Øµ + Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© + Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©">ğŸ“‹ Ù†Ø³Ø® (Ø§Ù„Ø¨Ù‚Ø±Ø© 255)</button>
          <button class="btn ghost" data-taf="${v.verse_key}" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØµØ±">ğŸ“˜ Ø§Ù„Ù…Ø®ØªØµØ±</button>
        </div>
        <div class="words" dir="rtl">${words}</div>
      </div>
    `;
  }).join('');

  // Ù†Ø³Ø®
  qsa('[data-copy]', ayahsEl).forEach(b=>{
    b.onclick = ()=>{
      copy(decodeHtml(b.getAttribute('data-copy')));
      b.textContent='âœ“ Ù†ÙØ³ÙØ®'; setTimeout(()=>b.textContent=b.title.includes('Ø§Ù„Ø³ÙˆØ±Ø©')?'ğŸ“‹':'ğŸ“‹',900);
    };
  });
  // ØªÙØ³ÙŠØ±
  qsa('[data-taf]', ayahsEl).forEach(b=>{
    b.onclick = ()=>{
      const key = b.getAttribute('data-taf');
      localStorage.setItem('last_verse', key);
      const html = AYAH_TAFSIR[key] || '<span class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ù…Ø®ØªØµØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¢Ù†.</span>';
      tBox.innerHTML = `<div style="line-height:1.9">${html}</div>`;
      // Scroll highlight
      const el = document.getElementById('a-'+key);
      el?.scrollIntoView({behavior:'smooth', block:'center'});
    };
  });
  // Tooltip Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª + Ø­ÙØ¸ Ø¢Ø®Ø± Ø¢ÙŠØ© Ù„Ù…Ø³Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  qsa('.word', ayahsEl).forEach(w=>{
    w.addEventListener('click', ()=>{
      const key = w.getAttribute('data-key')||'';
      if(key) localStorage.setItem('last_verse', key);
      const txt = w.getAttribute('data-mean')||'';
      if(!txt) return;
      showTip(w, txt);
    });
  });
}
function showTip(target, html){
  const tip = document.getElementById('tooltip');
  tip.style.display='block'; tip.innerHTML = html;
  const r = target.getBoundingClientRect();
  tip.style.right = (window.innerWidth - r.right + 8)+'px';
  tip.style.top = (r.top - tip.offsetHeight - 8 < 0 ? r.bottom + 8 : r.top - tip.offsetHeight - 8)+'px';
  setTimeout(()=>{ document.addEventListener('click', ()=> tip.style.display='none', {once:true}); },0);
}

/* ====== Events ====== */
document.getElementById('copyAll').onclick = ()=>{
  const txt = qsa('.ayah .words').map(d=>d.textContent.trim()).join('\n');
  copy(txt); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³ÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©.');
};
document.getElementById('prev').onclick = ()=> loadSurah(Math.max(1, CUR-1));
document.getElementById('next').onclick = ()=> loadSurah(Math.min(114, CUR+1));
document.getElementById('surahSel').addEventListener('change', e=> loadSurah(+e.target.value));
document.getElementById('searchAyah').addEventListener('input', ()=> loadSurah(CUR));
document.getElementById('optArabic').addEventListener('change', ()=> loadSurah(CUR));
document.getElementById('resume').onclick = ()=>{
  const ch = +(localStorage.getItem('last_ch')||1);
  const vkey = localStorage.getItem('last_verse')||'';
  if (ch !== CUR) { loadSurah(ch).then(()=> jumpTo(vkey)); }
  else jumpTo(vkey);
};
function jumpTo(vkey){
  if(!vkey) return;
  const el = document.getElementById('a-'+vkey);
  el?.scrollIntoView({behavior:'smooth', block:'center'});
  el?.classList.add('blink'); setTimeout(()=>el?.classList.remove('blink'),1200);
}

/* ====== Init ====== */
(async function init(){
  await fetchChapters();
  TAFSIR_ID = await resolveMukhtasarId();
  const last = +localStorage.getItem('last_ch') || 1;
  loadSurah(last);
})();
</script>
</body></html>
